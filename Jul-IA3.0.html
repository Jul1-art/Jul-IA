<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jul-IA ‚Ä¢ 3 mod√®les Mistral + Code Runner</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#070d1a;--bg2:#040913;--panel:#0e1628;--panel2:#0b1324;
    --muted:#9aa0a6;--text:#eafaf9;--neon:#00fff7;--accent:#00bfae;--accent2:#8b5cf6;--danger:#ff4d4f;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:radial-gradient(1200px 800px at 20% -10%,#0f1b33 0%,#070d1a 35%,#050a16 60%,#04080f 100%);
    color:var(--text);
    overflow:hidden;
  }
  /* Animated blobs background */
  .blobs::before,.blobs::after{content:"";position:fixed;inset:auto;filter:blur(60px);opacity:.45;z-index:0;pointer-events:none}
  .blobs::before{width:520px;height:520px;left:-120px;top:-120px;background:radial-gradient(circle at 30% 30%,#00fff7 0%,transparent 60%);animation:float1 18s ease-in-out infinite}
  .blobs::after{width:620px;height:620px;right:-160px;bottom:-160px;background:radial-gradient(circle at 70% 70%,#8b5cf6 0%,transparent 60%);animation:float2 22s ease-in-out infinite}
  @keyframes float1{0%,100%{transform:translate(0,0)}50%{transform:translate(40px,30px)}}
  @keyframes float2{0%,100%{transform:translate(0,0) scale(1)}50%{transform:translate(-30px,-20px) scale(1.05)}}

  .grid{position:relative;z-index:1;display:grid;grid-template-columns:320px 1fr 0px;gap:18px;height:100vh;padding:22px;transition:grid-template-columns .25s ease}
  .grid.code-open{grid-template-columns:320px 1fr 38vw;}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015));border:1px solid rgba(255,255,255,.06);border-radius:14px;box-shadow:0 10px 40px rgba(2,6,23,.6);backdrop-filter:blur(6px)}
  .side{display:flex;flex-direction:column;padding:16px;min-height:0}
  .brand{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  .logo{width:44px;height:44px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,#00182f,#00344f);color:var(--neon);font-weight:900;box-shadow:0 0 24px rgba(0,255,247,.18)}
  .muted{color:var(--muted)}

  .models{display:grid;grid-template-columns:1fr;gap:8px;margin:8px 0 10px}
  .mbtn{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid rgba(255,255,255,.06);background:transparent;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700;transition:all .18s}
  .mbtn:hover{transform:translateX(6px);border-color:var(--accent);box-shadow:0 8px 24px rgba(0,255,247,.1)}
  .mbtn.active{background:linear-gradient(90deg,rgba(0,255,247,.07),rgba(0,191,174,.03));border-color:var(--accent)}
  .mbtn .pill{font-size:12px;border:1px solid rgba(255,255,255,.14);padding:2px 8px;border-radius:999px;color:var(--muted)}

  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .tbtn{border:1px solid rgba(255,255,255,.06);background:transparent;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:600}
  .tbtn:hover{border-color:var(--accent)}

  .multi{display:flex;align-items:center;gap:6px;margin-top:8px}
  .switch{appearance:none;width:48px;height:26px;border-radius:999px;background:#1a2440;position:relative;outline:none;cursor:pointer;border:1px solid rgba(255,255,255,.12)}
  .switch::after{content:"";position:absolute;width:22px;height:22px;border-radius:50%;left:2px;top:1px;background:#9aa0a6;transition:.2s}
  .switch:checked{background:linear-gradient(90deg,#00fff7,#8b5cf6)}
  .switch:checked::after{left:24px;background:white}

  .list{flex:1;overflow:auto;margin-top:8px;padding-right:6px}
  .item{display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.04);cursor:pointer;transition:.18s}
  .item:hover{background:rgba(255,255,255,.03);transform:translateX(4px)}
  .itag{font-size:12px;color:var(--muted)}
  .spacer{height:8px}

  .main{display:flex;flex-direction:column;overflow:hidden}
  .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px 12px 18px;border-bottom:1px solid rgba(255,255,255,.06)}
  .title{display:flex;align-items:center;gap:10px}
  .pill{font-size:12px;border:1px solid rgba(255,255,255,.14);padding:4px 8px;border-radius:999px;color:var(--muted)}
  .rightBtns{display:flex;gap:8px;align-items:center}

  .chat{flex:1;overflow:auto;padding:22px;display:flex;flex-direction:column;gap:14px;position:relative;scroll-behavior:smooth}
  .msg{max-width:74%;padding:14px 16px;border-radius:14px;line-height:1.5;animation:bubble .25s ease-out;white-space:pre-wrap}
  .msg.user{margin-left:auto;background:linear-gradient(180deg,rgba(0,191,174,.18),rgba(0,191,174,.08));border:1px solid rgba(0,191,174,.22);color:var(--text);font-weight:600}
  .msg.bot{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08)}

  .lbl{display:inline-block;margin-bottom:6px;font-size:12px;opacity:.8}
  .typing{display:flex;gap:6px;align-items:center}
  .dot{width:8px;height:8px;border-radius:50%;background:var(--muted);animation:blink 1.2s infinite}
  .dot:nth-child(2){animation-delay:.12s}.dot:nth-child(3){animation-delay:.24s}
  @keyframes blink{0%{opacity:.3}50%{opacity:1}100%{opacity:.3}}
  @keyframes bubble{from{opacity:0;transform:translateY(10px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}

  .foot{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end;padding:14px;border-top:1px solid rgba(255,255,255,.06)}
  .in{width:100%;min-height:44px;max-height:160px;border:1px solid rgba(255,255,255,.12);background:transparent;color:var(--text);border-radius:12px;padding:12px 14px;resize:vertical}

  .send{background:var(--neon);color:#06121b;border:none;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer}
  .toBottom{position:absolute;right:16px;bottom:16px;z-index:5;display:none}
  .toBottom.show{display:block}
  .toBottom button{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#021018;border:none;border-radius:999px;padding:10px 14px;font-weight:800;cursor:pointer}

  /* Quick/Deep menu */
  .menu{position:relative}
  .menubtn{border:1px solid rgba(255,255,255,.14);background:transparent;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
  .dropdown{position:absolute;right:0;top:calc(100% + 6px);background:rgba(15,20,35,.96);border:1px solid rgba(255,255,255,.06);border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.35);display:none;min-width:220px;z-index:5}
  .dropdown.show{display:block}
  .option{padding:10px 12px;cursor:pointer}
  .option:hover{background:rgba(255,255,255,.06)}
  .hint{font-size:11px;color:var(--muted)}

  /* Code Runner (right panel) */
  .coder{display:flex;flex-direction:column;min-width:0}
  .codehead{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
  .ctitle{font-weight:800}
  .codebtns{display:flex;gap:8px}
  .codebtn{border:1px solid rgba(255,255,255,.14);background:transparent;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
  .codearea{flex:1;display:grid;grid-template-rows:1fr 42%;gap:8px;padding:10px;min-height:0}
  .editor{width:100%;height:100%;border:1px solid rgba(255,255,255,.12);background:#0b1120;color:var(--text);border-radius:10px;padding:10px;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;resize:none}
  .preview{border:1px solid rgba(255,255,255,.12);border-radius:10px;background:#0b1120;overflow:hidden}
  .preview iframe{width:100%;height:100%;border:0;background:white}
</style>
</head>
<body class="blobs">
<div class="grid" id="grid">
  <!-- SIDEBAR -->
  <aside class="card side">
    <div class="brand">
      <div class="logo">J</div>
      <div><div style="font-weight:800">Jul-IA</div><div class="muted" style="font-size:12px">3 mod√®les Mistral</div></div>
    </div>

    <div class="muted" style="font-size:12px">Mod√®le actif</div>
    <div class="models">
      <button class="mbtn" data-model="mistral-large">üìù Mistral-Large <span class="pill">texte</span></button>
      <button class="mbtn" data-model="codestral">üíª Codestral <span class="pill">code</span></button>
      <button class="mbtn" data-model="mathstral-7b">üî¢ Mathstral-7B <span class="pill">maths</span></button>
    </div>

    <div class="multi">
      <input id="multi" class="switch" type="checkbox" />
      <label for="multi" class="muted">R√©pondre avec les 3 mod√®les</label>
    </div>

    <div class="toolbar">
      <button class="tbtn" id="newBtn">‚ûï Nouveau</button>
      <button class="tbtn" id="renameBtn">‚úèÔ∏è Renommer</button>
      <button class="tbtn" id="deleteBtn">üóëÔ∏è Supprimer</button>
      <button class="tbtn" id="codeBtn">üß© Code</button>
    </div>

    <div class="list" id="convList"></div>
    <div class="muted" style="font-size:12px;margin-top:8px">Sauvegarde automatique locale</div>
  </aside>

  <!-- CHAT -->
  <section class="card main" role="main">
    <div class="head">
      <div class="title"><strong>Jul-IA</strong> <span class="pill" id="modelPill">‚Äî</span></div>
      <div class="rightBtns">
        <div class="menu" id="speedMenu" style="display:none">
          <button class="menubtn" id="speedBtn">R√©ponse ‚ñæ</button>
          <div class="dropdown" id="dropdown">
            <div class="option" data-speed="normal">Normal <div class="hint">r√©ponse standard (mistral-large)</div></div>
            <div class="option" data-speed="quick">R√©ponse rapide (2‚Äì3 s) <div class="hint">mod√®le l√©ger, coupe t√¥t</div></div>
            <div class="option" data-speed="deep">Think deeper (~30 s) <div class="hint">r√©ponse plus d√©taill√©e</div></div>
          </div>
        </div>
        <button class="tbtn" id="stopBtn" title="Arr√™ter">‚èπÔ∏è Stop</button>
      </div>
    </div>

    <div class="chat" id="chat">
      <div class="toBottom" id="toBottom"><button>Revenir en bas ‚ñΩ</button></div>
    </div>

    <div class="foot">
      <div><textarea id="input" class="in" placeholder="√âcris ton message‚Ä¶ (Maj+Entr√©e = ligne)"></textarea></div>
      <div><button id="send" class="send">Envoyer ‚ñ∑</button></div>
    </div>
  </section>

  <!-- CODE RUNNER (right) -->
  <aside class="card coder" id="coder">
    <div class="codehead">
      <div class="ctitle">Code Runner</div>
      <div class="codebtns">
        <select id="langSel" class="codebtn">
          <option value="auto">Auto</option>
          <option value="javascript">JavaScript</option>
          <option value="html">HTML</option>
        </select>
        <button class="codebtn" id="runCode">Ex√©cuter</button>
        <button class="codebtn" id="clearCode">Effacer</button>
        <button class="codebtn" id="closeCode">Fermer</button>
      </div>
    </div>
    <div class="codearea">
      <textarea id="editor" class="editor" spellcheck="false" placeholder="// Le code d√©tect√© sera coll√© ici automatiquement"></textarea>
      <div class="preview"><iframe id="preview" sandbox="allow-scripts allow-modals allow-downloads"></iframe></div>
    </div>
  </aside>
</div>

<script>
/************** CONFIG **************/
const API_KEY = "rZhHBEyvgPdhECcW00xVDq3r01VYZRGU"; // int√©gr√© c√¥t√© client (√† s√©curiser c√¥t√© serveur en prod)
const MODEL_MAP = {
  "mistral-large": "mistral-large-latest",
  "codestral": "codestral-latest",
  "mathstral-7b": "open-math-7b"
};
// Mod√®le l√©ger utilis√© pour "R√©ponse rapide" (on tente open-mistral-7b, sinon fallback large)
const QUICK_MODEL = "open-mistral-7b";

/************** STATE **************/
let state = {
  model: localStorage.getItem("julIA.model") || "mistral-large",
  conversations: JSON.parse(localStorage.getItem("julIA.conversations.v5") || "[]"),
  current: localStorage.getItem("julIA.current") || null,
  aborter: null,
  stickToBottom: true,
  speed: localStorage.getItem("julIA.speed") || "normal" // normal | quick | deep
};

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const nowISO = () => new Date().toISOString();
const saveAll = () => localStorage.setItem("julIA.conversations.v5", JSON.stringify(state.conversations));

function activeConv(){ return state.conversations.find(c=>c.id===state.current) || null; }
function uid(){ return "c_"+Math.random().toString(36).slice(2)+Date.now().toString(36); }

/************** CONVERSATIONS **************/
function createConversation(name){
  const c={ id:uid(), name:name||"Conversation", model:state.model, messages:[], createdAt:nowISO(), updatedAt:nowISO() };
  state.conversations.unshift(c); state.current=c.id;
  localStorage.setItem("julIA.current", state.current);
  saveAll(); renderList(); renderChat(); return c;
}
function renderList(){
  const box=$("#convList"); box.innerHTML="";
  state.conversations.forEach(c=>{
    const d=document.createElement("div"); d.className="item"; d.dataset.id=c.id;
    d.innerHTML=`<div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${c.name}</div><div class="itag">${new Date(c.updatedAt).toLocaleString()}</div>`;
    if(c.id===state.current) d.style.borderColor="var(--accent)";
    d.onclick=()=>{ state.current=c.id; localStorage.setItem("julIA.current",state.current); renderList(); renderChat(); };
    box.appendChild(d); box.appendChild(document.createElement("div")).className="spacer";
  });
}
function renameConversation(){
  const c=activeConv(); if(!c) return;
  const n=prompt("Nouveau nom :", c.name); if(n&&n.trim()){ c.name=n.trim(); c.updatedAt=nowISO(); saveAll(); renderList(); }
}
function deleteConversation(){
  const c=activeConv(); if(!c) return;
  if(!confirm("Supprimer cette conversation ?")) return;
  state.conversations = state.conversations.filter(x=>x.id!==c.id);
  saveAll();
  if(!state.conversations.length){ createConversation("Nouvelle"); }
  else { state.current=state.conversations[0].id; localStorage.setItem("julIA.current",state.current); }
  renderList(); renderChat();
}

/************** CHAT UI **************/
function setActiveModel(key){
  state.model=key; localStorage.setItem("julIA.model",key);
  $("#modelPill").textContent=key;
  $$(".mbtn").forEach(b=>b.classList.toggle("active", b.dataset.model===key));
  // afficher menu speed uniquement pour mistral-large
  $("#speedMenu").style.display = (key==="mistral-large") ? "block" : "none";
  const c=activeConv(); if(c){ c.model=key; c.updatedAt=nowISO(); saveAll(); renderList(); }
}

function addMsg(role,text,persist=true){
  const wrap=document.createElement("div"); wrap.className="msg " + (role==="user"?"user":"bot");
  wrap.appendChild(document.createTextNode(text));
  $("#chat").appendChild(wrap);
  if(persist){
    const c=activeConv(); if(c){ c.messages.push({role,content:text}); c.updatedAt=nowISO(); saveAll(); renderList(); }
  }
  maybeScroll();
  return wrap;
}

function addTyping(label){
  const m=document.createElement("div"); m.className="msg bot";
  const pill=document.createElement("span"); pill.className="lbl pill"; pill.textContent=label||"";
  const typing=document.createElement("div"); typing.className="typing"; typing.innerHTML='<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
  if(label) m.appendChild(pill);
  m.appendChild(typing);
  $("#chat").appendChild(m);
  maybeScroll();
  return m;
}

function renderChat(){
  const chat=$("#chat"); chat.innerHTML='<div class="toBottom" id="toBottom"><button>Revenir en bas ‚ñΩ</button></div>';
  const c=activeConv(); if(!c) return;
  $("#modelPill").textContent=c.model;
  c.messages.forEach(m=> addMsg(m.role,m.content,false));
  chat.scrollTop = chat.scrollHeight;
}

/************** AUTOSCROLL INTELLIGENT **************/
function userIsNearBottom(){ const chat=$("#chat"); return (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 80; }
$("#chat").addEventListener("scroll",()=>{ state.stickToBottom=userIsNearBottom(); $("#toBottom").classList.toggle("show", !state.stickToBottom); });
$("#toBottom").addEventListener("click",()=>{ $("#chat").scrollTo({top:$("#chat").scrollHeight, behavior:"smooth"}); });
function maybeScroll(){ if(state.stickToBottom){ $("#chat").scrollTop=$("#chat").scrollHeight; } }

/************** CODE RUNNER (right panel) **************/
const grid=$("#grid"), coder=$("#coder"), editor=$("#editor"), preview=$("#preview"), langSel=$("#langSel");
function openCodePanel(){ grid.classList.add("code-open"); }
function closeCodePanel(){ grid.classList.remove("code-open"); }
$("#codeBtn").addEventListener("click", openCodePanel);
$("#closeCode").addEventListener("click", closeCodePanel);
$("#clearCode").addEventListener("click", ()=>{ editor.value=""; runInPreview(""); });

function sniffCodeFrom(text){
  // Cherche le dernier bloc ```lang\n ... ```
  const re=/```(\w+)?\n([\s\S]*?)```/g; let m,last=null;
  while((m=re.exec(text))!==null){ last={lang:(m[1]||"").toLowerCase(), code:m[2]}; }
  return last;
}
function runInPreview(source){
  const mode=(langSel.value==="auto"?"auto":langSel.value);
  const looksHTML = mode==="html" || /<\s*html[\s>]/i.test(source) || /<\s*(head|body|script|style)\b/i.test(source);
  let html="";
  if(looksHTML){
    html = source;
  }else{
    // Ex√©cute JS dans un wrapper et log dans la page d'aper√ßu
    html = `<!doctype html><meta charset="utf-8"><title>Preview</title>
<style>body{font:14px/1.4 ui-monospace,Consolas,monospace;padding:12px}#log{white-space:pre-wrap}</style>
<h3>Console</h3><pre id="log"></pre>
<script>
(function(){
  const log = document.getElementById('log');
  const write = (...a)=>{ try{ log.textContent += a.map(x=>typeof x==='object'?JSON.stringify(x):String(x)).join(' ') + "\\n"; }catch(e){ log.textContent += String(a) + "\\n"; } };
  ['log','info','warn','error'].forEach(k=>{ const _old=console[k]; console[k]=(...args)=>{ write(...args); _old&&_old.apply(console,args); }; });
  try{
    ${source}
  }catch(e){ console.error(e && e.stack || e); }
})();
<\/script>`;
  }
  preview.srcdoc = html;
}

$("#runCode").addEventListener("click", ()=> runInPreview(editor.value));

/************** STREAMING MISTRAL **************/
function buildMessagesForPayload(baseMessages, speed){
  // Ajoute une consigne system pour quick/deep sans la persister
  const msgs = [...baseMessages];
  if(speed==="quick"){
    msgs.unshift({role:'system', content:'R√©ponds tr√®s bri√®vement et directement (2‚Äì3 phrases maximum).'});
  } else if(speed==="deep"){
    msgs.unshift({role:'system', content:'Fais une r√©ponse d√©taill√©e, bien structur√©e (titres courts, listes si utile). √âvite d‚Äôexposer ton raisonnement interne.'});
  }
  return msgs;
}

async function streamChat(modelKey, userText, labelOverride=null, speedMode="normal"){
  const conv=activeConv(); if(!conv) return;
  // Ajoute le message utilisateur (pr√©serve les retours √† la ligne)
  addMsg("user", userText, true);

  // √âl√©ment "typing‚Ä¶" pendant l'attente
  const typingNode = addTyping(labelOverride || modelKey);

  // Pr√©pare les messages pour l‚ÄôAPI (sans champ model par message)
  const payloadMessages = buildMessagesForPayload(conv.messages, speedMode);

  // Choix du mod√®le effectif
  let selectedModel = MODEL_MAP[modelKey] || MODEL_MAP[state.model];
  if(modelKey==="mistral-large" && speedMode==="quick"){
    selectedModel = QUICK_MODEL; // tentative mod√®le l√©ger
  } else if(modelKey==="mistral-large" && speedMode==="deep"){
    selectedModel = MODEL_MAP["mistral-large"]; // mod√®le large
  }

  // Abort en cours ?
  if(state.aborter) { try{ state.aborter.abort(); }catch(e){} }
  state.aborter = new AbortController();

  // Timer d‚Äôarr√™t pour QUICK afin de vraiment couper court (~3s)
  let quickTimer=null;
  if(modelKey==="mistral-large" && speedMode==="quick"){
    quickTimer = setTimeout(()=>{ try{ state.aborter && state.aborter.abort(); }catch(e){} }, 3200);
  }

  try{
    const resp = await fetch("https://api.mistral.ai/v1/chat/completions",{
      method:'POST',
      headers:{'Authorization':'Bearer '+API_KEY,'Content-Type':'application/json'},
      body:JSON.stringify({ model:selectedModel, messages: payloadMessages, temperature:0.2, stream:true }),
      signal: state.aborter.signal
    });
    if(!resp.ok){
      let t=""; try{ t=await resp.text(); }catch{}
      typingNode.innerHTML = "‚ùå Erreur API: " + t;
      conv.messages.push({role:"assistant", content: typingNode.textContent}); conv.updatedAt=nowISO(); saveAll(); return;
    }
    const reader=resp.body.getReader(); const decoder=new TextDecoder('utf-8');
    let acc="", final="";
    while(true){
      const {value, done}=await reader.read(); if(done) break;
      acc += decoder.decode(value,{stream:true});
      const lines = acc.split(/\n/); acc=lines.pop()||"";
      for(const ln of lines){
        const s = ln.trim(); if(!s || !s.startsWith("data:")) continue;
        const data = s.slice(5).trim(); if(data==="[DONE]") continue;
        try{
          const j=JSON.parse(data);
          const delta=(j.choices && j.choices[0] && j.choices[0].delta && j.choices[0].delta.content) || "";
          if(delta){
            if(typingNode.querySelector(".typing")) typingNode.innerHTML = (labelOverride||modelKey) ? `<span class="lbl pill">${labelOverride||modelKey}</span>` : "";
            typingNode.appendChild(document.createTextNode(delta));
            final += delta;
            maybeScroll();
          }
        }catch{}
      }
    }
    // Enregistre la r√©ponse finale
    conv.messages.push({role:"assistant", content: final}); conv.updatedAt=nowISO(); saveAll();

    // D√©tection et ouverture auto du code runner si code dans la r√©ponse
    const blk = sniffCodeFrom(final);
    if(blk){
      openCodePanel();
      editor.value = blk.code;
      langSel.value = (blk.lang==="js"?"javascript": (blk.lang||"auto"));
      runInPreview(editor.value);
    }
  }catch(err){
    if(err.name!=="AbortError"){
      typingNode.innerHTML = "‚ùå Erreur : " + (err.message||String(err));
      conv.messages.push({role:"assistant", content: typingNode.textContent}); conv.updatedAt=nowISO(); saveAll();
    }
  }finally{
    if(quickTimer) clearTimeout(quickTimer);
    state.aborter=null;
  }
}

/************** MULTI / SINGLE **************/
async function sendMessage(){
  const text = $("#input").value; // ne pas trim -> on garde les retours
  if(!text) return;
  $("#input").value="";
  if($("#multi").checked){
    await streamChat("mistral-large", text, "mistral-large" + (state.speed!=="normal" ? " ‚Ä¢ "+state.speed : ""), state.speed);
    await streamChat("codestral", text, "codestral");
    await streamChat("mathstral-7b", text, "mathstral-7b");
  } else {
    await streamChat(state.model, text, null, state.model==="mistral-large" ? state.speed : "normal");
  }
}

/************** UI BINDINGS **************/
$("#send").addEventListener("click", sendMessage);
$("#input").addEventListener("keydown",e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); $("#send").click(); }});
$("#stopBtn").addEventListener("click",()=>{ if(state.aborter) try{ state.aborter.abort(); }catch{} });

$$(".mbtn").forEach(b=> b.addEventListener("click",()=> setActiveModel(b.dataset.model)));
$("#newBtn").addEventListener("click",()=> createConversation("Nouvelle"));
$("#renameBtn").addEventListener("click",renameConversation);
$("#deleteBtn").addEventListener("click",deleteConversation);

// Speed menu (only shows on mistral-large)
const speedBtn=$("#speedBtn"), dropdown=$("#dropdown");
$("#speedMenu").addEventListener("click", (e)=>{ dropdown.classList.toggle("show"); e.stopPropagation(); });
document.addEventListener("click", ()=> dropdown.classList.remove("show") );
dropdown.querySelectorAll(".option").forEach(opt=>{
  opt.addEventListener("click", ()=>{
    state.speed = opt.dataset.speed || "normal";
    localStorage.setItem("julIA.speed", state.speed);
    dropdown.classList.remove("show");
    speedBtn.textContent = (state.speed==="normal" ? "R√©ponse ‚ñæ" : `R√©ponse (${state.speed}) ‚ñæ`);
  });
});

// Code panel open when a code response appears is handled after stream; manual open button already bound

/************** INIT **************/
(function init(){
  if(!state.conversations.length){
    const c=createConversation("Bienvenue");
    state.current=c.id;
  } else if(!state.current){
    state.current=state.conversations[0].id;
  }
  renderList(); renderChat();
  setActiveModel(state.model);
  speedBtn.textContent = (state.speed==="normal" ? "R√©ponse ‚ñæ" : `R√©ponse (${state.speed}) ‚ñæ`);
  // Message d'accueil si vide
  const c=activeConv();
  if(c && !c.messages.length){
    addMsg("assistant","Choisis un mod√®le et pose ta question.\n\n‚Ä¢ Active ¬´ R√©pondre avec les 3 mod√®les ¬ª pour comparer.\n‚Ä¢ Sur mistral-large, clique ¬´ R√©ponse ¬ª pour choisir : rapide (2‚Äì3 s) ou think deeper (~30 s).\n‚Ä¢ Quand une r√©ponse contient du code, le panneau ¬´ Code ¬ª s‚Äôouvre √† droite pour ex√©cuter le JS/HTML.\n‚Ä¢ Tu peux scroller en haut pendant que j‚Äô√©cris ‚Äî j‚Äôessaie de ne pas te ramener en bas automatiquement.");
  }
})();
</script>
</body>
</html>
